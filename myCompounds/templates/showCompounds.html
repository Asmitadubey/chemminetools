{% extends "base.html" %}
{% load cms_tags %}

{% block js_content %}

{% include "selectize.html" %}
{% include "dataTables.html" %}
{% include "alertify.html" %}

<style>
	.spaceAfter {
		margin-bottom: 10px;
	}
</style>

<script type="text/javascript">
	var structures_loaded = false;
	var table;

	alertify.dialog("selectTags",function(){},true,'prompt');


	$(document).ready(function() {
		$.ajaxSetup({
			  headers: { "X-CSRFToken": '{{csrf_token}}' }
		});
		$('.fa-trash-alt').click(DeleteRow);
		$("[data-toggle=tooltip]").tooltip();

		$("#tags").selectize({
			plugins: ['remove_button'],
			create: true,
		});



		table = $('.table').DataTable( {
			dom: '<"row-fluid spaceAfter" Bi>frltip',
			buttons: {
				buttons: ['selectAll','selectNone',
					createTagAddRemoveButton("add"),
					createTagAddRemoveButton("remove"),
					createDeleteButton(),
				],
			},
			select: true,
			initComplete: function(){
				$('.table-body').show();
			},
		 } );
		//table.buttons().container().appendTo( $("#top_buttons"));

		new $.fn.dataTable.Buttons( table, {
		    buttons: {
					    }
		} );

		$('.table').on('draw.dt',function(){
			console.log("page change");
			if (structures_loaded) {
				showCompounds();
			} else {
				hideCompounds();
			}

		});


		$("#loadstructures").click(function () {
			if (!structures_loaded) {
				showCompounds();
			} else {
				hideCompounds();
			}
		});
	});
	function showCompounds(){
		console.log("showing compounds");
		$("#loadstructures").html('Hide Structures');
		$(".compoundImage").show();
		$(".compoundImageTitle").show();
		$(".compoundImage").each(function() {
			$(this).html('<img width="150" class="img-rounded" src="/compounds/'+ $(this).attr('id')  + '/png"/>');
		});
		structures_loaded = true;

	}
	function hideCompounds(){
		console.log("hiding compounds");
		$("#loadstructures").html('Show Structures');
		structures_loaded = false;
		$(".compoundImage").hide();
		$(".compoundImageTitle").hide();
		$(".compoundImage").each(function() {
			$(this).html('');
		});

	}
	function createDeleteButton(){
		return {
			text: "Delete Selected",
			className:"btn-danger",
			action: function(event,dt,note,config){
				var selectedRows = dt.rows( { selected: true } );
				console.log("selected rows:",selectedRows);
				selectedIds =  Array.from(selectedRows.ids());
				console.log("ids to delete: ",selectedIds);
				if(selectedIds.length === 0){
					alertify.error("No compounds selected!");
				}else{
					alertify.confirm("Delete","Are you sure you wanted to delete "+selectedIds.length+
							" compound(s)?",
						function(){
							$.post( "/compounds/batch/delete", {id: selectedIds}).
								then(function(){
									console.log("selected rows to delete:",selectedRows);
									selectedRows.remove().draw();
									alertify.success("Compounds deleted");
								}).fail(function(){
									alertify.error("Failed to delete selected compounds ");
								});
						},function(){});
				}
			}
		};
	}
	function createTagAddRemoveButton(action){
		var actionText = action === "add" ? "Add Tags" : "Remove Tags";
		
		return	{
			text: actionText,
			action: function(event,dt,note,config){
				var selectedIds;
				var content = jQuery("#tag_input")[0];
				selectedIds =  Array.from(dt.rows( { selected: true } ).ids());
				console.log("selected Ids: ",Array.from(selectedIds));
				jQuery("#tags")[0].selectize.clear();

				console.log("data: ",selectedIds);
				alertify.selectTags("").set({
					title: actionText,
					onok: function(){
						var tags,info;
						console.log("ok clicked");
						tags = jQuery("#tags")[0].selectize.items;
						console.log("tags to add/remove: ",tags);
						info={ids: selectedIds, tags: tags};
						console.log("info: ",info);

						jQuery.ajax({
							url: "/compounds/tagCompounds/"+action,
							type: "POST",
							contentType: "application/json",
							data: JSON.stringify(info),
						}).then(function(result){
							console.log("tagging succeeded",result);
							location.reload();
						}).fail(function(result){
							alertify.error("Failed to save compounds tags");
							console.log("saving compound tags failed. result: ",result);
						});
					},
				}).setContent(content);
			},
		};
	}

	function DeleteRow()
	{
		var self=this;
		var compound_id;
	        compound_id= $(self).parents('tr').first().attr("id");
		$.post( "/compounds/batch/delete", {id: [compound_id]}).
			then(function(){
				$(self).parents('tr').first().remove();
			}).fail(function(){
				alertify.error("failed to delete compound "+compound_id);
			});
	}
</script>
{% endblock %} 

{% block base_content %}
<div class="row"> 
<div class="col-md-12">
<h2>My Compounds</h2>
</div>
</div><!--/row--> 
<div class="row">
	<div class="col-md-12">
		<div class="btn-group" id="top_buttons">
		  <button id="loadstructures" class="btn btn-outline-primary">Show Structures</button>
		  <a href="/myCompounds/downloadSDF.sdf" download="myCompounds.sdf"><button class="btn btn-outline-primary">Download SDF</button></a>
		  <a href="/myCompounds/downloadSMILES.smi" download="myCompounds.smi"><button class="btn btn-outline-primary">Download Smiles</button></a>
		</div>
	</div> 
</div><!--/row-->

<div class="row">


<div class="col-md-12">
<p>&nbsp;
{% if matches %}
	<table class="table table-sm" >
	<thead>
	<tr>
	<th>CID</th>
	<th>Name</th>
	<th style="display:none" class="compoundImageTitle">Structure</th>
	<th>Formula</th>
	<th>Tags</th>
	<th>Options</th>
	</tr>
	</thead>
	<tbody class="table-body" style="display:none">
	{% for compound in matches %}
		<tr id="{{compound.id}}">
		<td><a href="/compounds/{{compound.id}}">{{compound.cid}}</a></td>
		<td>{{compound.name}}</td>
		<td style="display:none" class="compoundImage" id="{{compound.id}}">  </td>
		<td>{{compound.formula}}</td>
		<td>{%for tag in compound.tags.all %}
			{{tag.name}},
		    {% endfor %}
		</td>
			
		<td><!--<i data-toggle="tooltip" placement="top" title="Delete this compound" class="fas fa-trash-alt"></i>-->
		<a href="/eisearch/query/?smi={{compound.smiles}}" class="searchRowButton" data-toggle="tooltip" placement="top" title="Search similar compounds"><i class="fas fa-search"></i></a>
		<a href="/compounds/{{compound.id}}/editform" class="editRowButton" data-toggle="tooltip" placement="top" title="Edit compound details"><i class="fas fa-pen"></i></a>
		</td>
		</tr>
	{% endfor %}
	</tbody>
	</table>
{% else %}
<p>No compounds uploaded.</p>
{% endif %}
</div>


</div><!--/row-->
<div class="row">
	<div class="col-md-12">
		<div style="display:none">
			<div id="tag_input" >
				<label class="control-label" for="tags">Compound Tags:</label>
				<select id="tags" name="tags" multiple placeholder="Compound Tags" style="display:none">
					{% for tag in tags %}
						<option value="{{tag}}">{{tag}}</option>
					{% endfor %}
				</select>
			</div>
		</div>
	</div>
</div><!--/row-->
{% endblock %}
