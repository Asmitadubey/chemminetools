{% extends "base.html" %}
{% load cms_tags %}
{% load targetsearch_extras %}

{% block extra_styles %}
.column-set {
	border: 1px solid #ccc;
	border-radius: 16px;
	padding: 0.01em 16px;
	margin: 1em;
}
{% endblock extra_styles %}

{% block base_content %}
<div class="container-fluid">
	<div class="row">
		<div class="col-md-12">
			{% if message %}<span style="color: red">{{message}}</span>{% endif %}
			<ul class="nav nav-tabs" id="searchTabs">
				<li class="nav-item">
					<a class="nav-link{% if id_type == "compound" %} active{% endif %}" href="#compound_search" data-toggle="tab">Search By Compound</a>
				</li>
				<li class="nav-item">
					<a class="nav-link{% if id_type == "target" %} active{% endif %}" href="#target_search" data-toggle="tab">Search By Target</a>
				</li>
			</ul>

			<div class="tab-content" style="overflow: visible">

				<div class="tab-pane{% if id_type == "compound" %} active{% endif %}" id="compound_search">
					<div class="container-fluid">
						<div class="col-md-12">
							<form method="GET">
								<div class="form-group mt-3">
									<label for="source-id-select">Database:</label>
									<select id="source-id-select" name="source_id">
									{% for id,name in compoundDbs.items|order_by:1 %}
										<option value="{{id}}" {% if defaultCompoundDb == id %}selected {% endif %} >{{name}}</option>
									{% endfor %}
									</select>

                                    <br/>

                                    <label for="query-mapping--id-select">Similarity Mapping:</label>
									<select id="query-mapping-select" name="similarity_job_id">
										<option value="-1" >None</option>
									{% for id,name in similarityJobs %}
										<option value="{{id}}" >{{name}}</option>
									{% endfor %}
									</select>


									<ul class="nav nav-tabs" id="searchCompoundTabs">
									  <li class="nav-item">
										<a class="nav-link active" href="#workbench" data-toggle="tab">Workbench</a>
									  </li>
									  <li class="nav-item">
										<a class="nav-link" href="#compoundids" data-toggle="tab">Compound IDs</a>
									  </li>
									</ul>
									<div class='tab-content'>
										<div id="workbench" class='tab-pane active'>
											 <div class="card text-white bg-secondary my-3 p-2">
												<h6 class='card-title'>Import compound IDs from workbench</h6>
												<p><span id="compound_count">0</span> compounds selected.</p>
												<select id="tags" name="tags" multiple placeholder="Compound Tags">
													<option value="all">All</option>
													{% for tag in tags %}
														<option value="{{tag}}">{{tag}}</option>
													{% endfor %}
												</select>
											</div>

										</div>
										<div id="compoundids" class='tab-pane '>
											<div class="card text-white bg-secondary my-3 p-2">
												<h6 class='card-title' for="compound-ids">Enter Compound IDs</h6>
												<p>Use the 'Compound Name Search' box to search for compounds
												by name, or enter compound IDs into the box below.</p>
												<select id="compound_autocomplete" placeholder="Compound Name Search"></select>
												<textarea id="compound-ids" name="ids" class="form-control" rows="10" placeholder="Enter space-separated ID(s)"></textarea>
											</div>
										</div>
									</div>
									<input type="hidden" name="id_type" value="compound">
									<button type="submit" class="btn btn-primary">Search</button>
								</div>
							</form>
						</div>
					</div>
				</div>

				<div class="tab-pane{% if id_type == "target" %} active{% endif %}" id="target_search">
					<div class="container-fluid">
						<div class="col-md-12">
							<form method="GET">
								<div class="form-group mt-3">
									<label for="source-id-select">Database:</label>
									<select id="source-id-select" name="source_id">
									{% for id,name in proteinDbs.items|order_by:1 %}
										<option value="{{id}}" {% if defaultProteinDb == id %}selected {% endif %} >{{name}}</option>
									{% endfor %}
									</select>

									<div class="card text-white bg-secondary my-3 p-2">
										<h6 class="card-title" for="target-ids">Enter Target IDs</h6>
										<p>Use the 'Target Name Search' box to search for targets
										by name, or enter target IDs into the box below.</p>
										<select id="target_autocomplete" placeholder="Target Name Search"></select>
										<textarea id="target-ids" name="ids" class="form-control" rows="10" placeholder="Enter space-separated ID(s)"></textarea>
									</div>
									<div>
										<input id="include-activity-chkbox" type="checkbox" name="include_activity">
										<label for="include-activity-chkbox">&nbsp;Include Activity Results (slow)</label>
									</div>
									<input type="hidden" name="id_type" value="target">
									<button type="submit" class="btn btn-primary">Search</button>
								</div>
							</form>
						</div>
					</div>
				</div>

			</div><!-- end tab-content -->
		</div>
	</div><!-- end row (form tabs)-->

	{% if query_submit %}
		{% include "targetsearch/ts_table.html" with table_name="annotation" table_info=annotation_info table_data=annotation_matches drugind_json=drugind_json grouping_col=groupingCol %}
		{% if activity_matches is not None %}
			{% include "targetsearch/ts_table.html" with table_name="activity" table_info=activity_info table_data=activity_matches drugind_json=drugind_json grouping_col=groupingCol %}
		{% endif %}
	{% endif %}
</div><!-- end container-fluid -->

{% include "compounddb/compound_img_modal.html" %}
{% endblock base_content %}

{% block js_content %}

{% include "selectize.html" %}
{% include "dataTables.html" %}
{% include "alertify.html" %}

<script type="text/javascript">
	function setCompoundCount(tags) {
		if(tags != null && tags.length !== 0)
			$.get("/compounds/withTags/"+tags.join(",")+"/count").
				then(function(result){
					$("#compound_count").html(result);
				}).fail(function(){
					alertify.error("failed to update compound count");
				});
		else
			$("#compound_count").html(0);
	}
	function strjoin(a, b) {
		a = a.trim();
		b = b.trim();

		if (a == '')
			return b;
		else if (b == '')
			return a;
		else
			return (a + ' ' + b);
	}

	$(document).ready(function() {
		jQuery("#tags").selectize({
			plugins: ['remove_button'],
			onChange: function(value){
				setCompoundCount(value);
			},
		});
		jQuery("#compound_autocomplete").selectize({
			valueField: "chembl_id",
			labelField: "name",
			searchField: ["name"],
			load: function(query, callback) {
				if (!query.length || query.length < 3) {
					//console.log("compound_autocomplete: Empty query or query too short");
					return callback();
				} else {
					jQuery.get("compoundNames/" + query).then( function(result) {
						//console.log("compound_autocomplete: Got back suggestions:", result);
						callback(result);
					});
				}
			},
			onChange:function(value) {
				if(value == null || value === "")
					return;
				//console.log("compound_autocomplete: new compound selected:",value);
				var compoundArea = jQuery("#compound-ids");
				compoundArea.val(strjoin(compoundArea.val(), value));
			},
		});

		jQuery("#target_autocomplete").selectize({
			valueField: "accession_id",
			labelField: "name",
			searchField: ["name"],
			load: function(query, callback) {
				if (!query.length || query.length < 3) {
					//console.log("target_autocomplete: Empty query or query too short");
					return callback();
				} else {
					//console.log("target_autocomplete: Loading suggestions for:", query);
					jQuery.get("targetNames/" + query).then( function(result) {
						//console.log("target_autocomplete: Got back suggestions:", result);
						callback(result);
					});
				}
			},
			onChange: function(value) {
				if (value == null || value === "")
					return;
				var targetArea = jQuery("#target-ids");
				targetArea.val(strjoin(targetArea.val(), value));
			},
		});


		$("[data-toggle=tooltip]").tooltip();
	});
</script>

{% endblock js_content %}
